<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alien Slope Shooter</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘½</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <style>
    /* ... (all your original <style> content is unchanged) ... */
    </style>
</head>
<body class="text-gray-100 flex items-center justify-center min-h-screen p-4">

    <canvas id="background-canvas"></canvas>

    <div class="w-full max-w-4xl mx-auto bg-gray-900 bg-opacity-80 backdrop-blur-sm p-6 rounded-lg shadow-2xl border border-gray-700">
        <h1 class="text-3xl font-bold text-center text-green-400 mb-4" style="text-shadow: 0 0 10px #00ff00;">
            Alien Slope Shooter
        </h1>
        <p class="text-center text-gray-300 mb-6">
            Your cannon is on the Y-axis. Find the slope (y/x) for the equation <code>y = kx + b</code>!
        </p>

        <div class="flex flex-col lg:flex-row gap-6">
            <div class="flex-grow flex justify-center items-center">
                <canvas id="game-canvas" width="420" height="420" class="game-canvas"></canvas>
            </div>

            <div class="flex-shrink-0 lg:w-1/3 bg-gray-800 p-6 rounded-lg border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-green-300">Targeting Computer</h2>
                    <button id="help-button" class="text-sm text-blue-400 hover:text-blue-300 underline font-sans">How to Play</button>
                </div>

                <div id="message-box" class="h-16 text-center text-lg font-semibold mb-4 flex items-center justify-center p-2 rounded-md bg-gray-900 border border-gray-700">
                    <span id="message-text" class="message-info">Connecting to server...</span>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-center text-green-300 mb-2">SCOREBOARD</h3>
                    <div id="scoreboard" class="space-y-2 max-h-32 overflow-y-auto p-2 bg-gray-900 rounded border border-gray-700">
                        </div>
                </div>

                <div class="text-center mb-4">
                    <h3 class="text-2xl font-bold text-red-400" style="text-shadow: 0 0 8px #ef4444;">
                        YOUR LIVES: <span id="lives-display">3</span>
                    </h3>
                </div>

                <div class="text-center mb-6">
                    <label class="text-2xl font-bold text-gray-300">EQUATION:</label>
                    <div class="flex justify-center items-center mt-3 space-x-2 text-3xl font-bold">
                        <span class="text-gray-400">y =</span>
                        <div class="flex flex-col items-center">
                            <input type="number" id="rise-input" class="coord-input !w-16 !text-lg" placeholder="y">
                            <div class="w-16 h-1 bg-gray-400 my-1 rounded"></div>
                            <input type="number" id="run-input" class="coord-input !w-16 !text-lg" placeholder="x">
                        </div>
                        <span class="text-gray-400">x +</span>
                        <span class="text-blue-400 text-4xl" style="text-shadow: 0 0 8px #3b82f6;">b</span>
                    </div>
                </div>
                
                <div class="flex flex-col gap-4">
                    <button id="shoot-button" class="btn btn-green" disabled>Fire Laser</button>
                    </div>

            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    window.addEventListener('load', () => {
        // --- Client-side Socket Connection ---
        const socket = io();

        // --- Global Variables (Game) ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const gridSize = 20;
        const gridMax = 10;
        const centerX = canvasWidth / 2;
        const centerY = canvasHeight / 2;

        // --- Game state (synced from server) ---
        let cannonYIntercept = 0; // Server will tell us this
        let currentAliens = [];   // Server will tell us this
        
        let cannonAngle = 0; 
        let targetAngle = 0; 
        let isGameActive = true; 

        // Cannon Image (unchanged from your code)
        const cannonImage = new Image();
        let isCannonImageLoaded = false;
        cannonImage.src = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><g fill=%22%239ca3af%22><rect x=%2240%22 y=%2240%22 width=%2220%22 height=%2220%22 rx=%225%22 /><rect x=%2245%22 y=%2210%22 width=%2210%22 height=%2240%22 rx=%223%22 /><rect x=%2245%22 y=%2250%22 width=%2210%22 height=%2240%22 rx=%223%22 /></g></svg>';
        cannonImage.onload = () => { isCannonImageLoaded = true; updateCannonAngle(); };

        // DOM Elements
        const shootButton = document.getElementById('shoot-button');
        const riseInput = document.getElementById('rise-input');
        const runInput = document.getElementById('run-input');
        const messageText = document.getElementById('message-text');
        const messageBox = document.getElementById('message-box');
        const livesDisplay = document.getElementById('lives-display');
        const scoreboard = document.getElementById('scoreboard');

        // Modal Elements (unchanged from your code)
        const modal = document.getElementById('how-to-play-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalOkButton = document.getElementById('modal-ok-button');
        const helpButton = document.getElementById('help-button');

        // --- Helper Functions (Mostly Rendering) ---
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        function showModal() { modal.classList.remove('hidden'); }
        function hideModal() { modal.classList.add('hidden'); }

        function gridToCanvas(x, y) {
            const canvasX = centerX + x * gridSize;
            const canvasY = centerY - y * gridSize; 
            return { canvasX, canvasY };
        }

        // --- All draw functions are (mostly) unchanged ---
        // They just READ from the global state. They don't change it.
        function drawAxes() {
            ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, centerY); ctx.lineTo(canvasWidth, centerY); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvasHeight); ctx.stroke();
            ctx.fillStyle = '#00ff00'; ctx.font = '10px Orbitron'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            for (let i = -gridMax; i <= gridMax; i++) {
                if (i === 0) continue;
                if (i % 2 === 0) {
                    const { canvasX } = gridToCanvas(i, 0);
                    ctx.fillText(i, canvasX, centerY + 12);
                }
                if (i % 2 === 0) {
                    const { canvasY } = gridToCanvas(0, i);
                    ctx.fillText(i, centerX - 12, canvasY);
                }
            }
        }
        function drawGridLines() {
            ctx.strokeStyle = '#004d00'; ctx.lineWidth = 0.5;
            for (let i = -gridMax; i <= gridMax; i++) {
                if (i === 0) continue;
                const { canvasX } = gridToCanvas(i, 0);
                ctx.beginPath(); ctx.moveTo(canvasX, 0); ctx.lineTo(canvasX, canvasHeight); ctx.stroke();
                const { canvasY } = gridToCanvas(0, i);
                ctx.beginPath(); ctx.moveTo(0, canvasY); ctx.lineTo(canvasWidth, canvasY); ctx.stroke();
            }
        }
        function drawGame() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            drawGridLines();
            drawAxes();
            drawAliens();
            drawCannon();
        }
        function drawAliens() {
            currentAliens.forEach(alien => {
                const { canvasX, canvasY } = gridToCanvas(alien.x, alien.y);
                ctx.font = '24px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('ðŸ‘½', canvasX, canvasY);
            });
        }
        function drawCannon() {
            const { canvasX, canvasY } = gridToCanvas(0, cannonYIntercept);
            ctx.save();
            ctx.translate(canvasX, canvasY);
            ctx.rotate(cannonAngle + Math.PI / 2);
            if (isCannonImageLoaded) {
                ctx.drawImage(cannonImage, -22.5, -22.5, 45, 45);
            } else {
                ctx.fillStyle = '#9ca3af';
                ctx.fillRect(-15, -15, 30, 30);
                ctx.fillRect(-7.5, -45, 15, 30);
                ctx.fillRect(-7.5, 15, 15, 30);
            }
            ctx.restore();
        }
        function drawLaser(slope, color) {
            const drawLimitX = gridMax + 2;
            const y1 = slope * (-drawLimitX) + cannonYIntercept;
            const y2 = slope * (drawLimitX) + cannonYIntercept;
            const { canvasX: startLineX, canvasY: startLineY } = gridToCanvas(-drawLimitX, y1);
            const { canvasX: endLineX, canvasY: endLineY } = gridToCanvas(drawLimitX, y2);
            ctx.strokeStyle = color; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(startLineX, startLineY); ctx.lineTo(endLineX, endLineY); ctx.stroke();
        }
        function drawExplosion(x, y) {
            const { canvasX, canvasY } = gridToCanvas(x, y);
            ctx.fillStyle = '#fde047';
            ctx.beginPath(); ctx.arc(canvasX, canvasY, 15, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#f97316';
            ctx.beginPath(); ctx.arc(canvasX, canvasY, 8, 0, Math.PI * 2); ctx.fill();
        }

        // This is now just for the UI
        function updateMessage(text, type = 'info') {
            messageText.textContent = text;
            messageBox.className = messageBox.className.replace(/message-(hit|miss|info)/g, '');
            messageBox.classList.add(`message-${type}`);
        }

        // This is for aiming the cannon
        function getPlayerSlope() {
            const rise = parseFloat(riseInput.value);
            const run = parseFloat(runInput.value);
            if (isNaN(rise) || isNaN(run)) return { k: NaN, valid: false, error: 'Invalid input!' };
            if (run === 0) return { k: NaN, valid: false, error: 'Run (x) cannot be zero!' };
            return { k: rise / run, valid: true, error: null };
        }
        function updateCannonAngle() {
            const playerSlope = getPlayerSlope();
            if (playerSlope.valid) {
                const rise = -playerSlope.k;
                const run = 1;
                targetAngle = Math.atan2(rise, run);
            } else {
                targetAngle = Math.atan2(0, 1);
            }
        }

        // This just renders the cannon angle
        function gameLoop() {
            if (!isGameActive) return;
            let angleDiff = targetAngle - cannonAngle;
            while (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
            while (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
            cannonAngle += angleDiff * 0.1;
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // --- Event Handlers (Client-side) ---
        function handleShoot() {
            const playerSlope = getPlayerSlope();
            if (!playerSlope.valid) {
                updateMessage(playerSlope.error || 'Invalid slope!', 'miss');
                return;
            }
            
            // *** CHANGE: Send the shot to the server ***
            socket.emit('shoot', { k: playerSlope.k });
        }

        function handleModalOk() {
            hideModal();
            try {
                document.cookie = "hasVisited=true; max-age=31536000; path=/; SameSite=Lax";
            } catch (e) { console.warn("Cookies might be disabled."); }
        }

        // --- *** NEW: Socket Event Listeners *** ---
        socket.on('connect', () => {
            updateMessage('Connected! Waiting for target...', 'info');
            shootButton.disabled = false;
        });

        socket.on('newRound', (data) => {
            // Server is giving us a new alien and cannon position
            cannonYIntercept = data.b;
            currentAliens = [data.alien]; // Put it in an array for drawAliens()
            
            updateMessage('New target acquired!', 'info');
            shootButton.disabled = false;
            
            // Reset inputs and aim
            riseInput.value = '';
            runInput.value = '';
            updateCannonAngle();
            
            isGameActive = true;
            gameLoop(); // Make sure loop is running
        });

        socket.on('updatePlayers', (players) => {
            scoreboard.innerHTML = ''; // Clear scoreboard
            
            // Sort players by score
            const sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex justify-between items-center text-sm';
                
                // Highlight the current player
                const isMe = (player.id === socket.id);
                if (isMe) {
                    playerEl.innerHTML = `
                        <span class="font-bold text-green-300">${player.name} (You)</span>
                        <span class="font-bold text-green-300">Score: ${player.score} | Lives: ${player.lives}</span>
                    `;
                    // Update your personal lives display
                    livesDisplay.textContent = player.lives;
                } else {
                    playerEl.innerHTML = `
                        <span>${player.name}</span>
                        <span>Score: ${player.score} | Lives: ${player.lives}</span>
                    `;
                }
                scoreboard.appendChild(playerEl);
            });
        });

        socket.on('hit', (data) => {
            // Someone got a hit!
            updateMessage(`HIT! by ${data.playerName}!`, 'hit');
            const alienSlope = (data.alien.y - cannonYIntercept) / data.alien.x;
            drawLaser(alienSlope, '#00ff00');
            drawExplosion(data.alien.x, data.alien.y);
            
            currentAliens = []; // Alien is gone
            shootButton.disabled = true; // Wait for next round
        });
        
        socket.on('myMiss', (data) => {
            // You missed!
            updateMessage(`MISS! Correct slope is ${data.correctSlope.toFixed(3)}`, 'miss');
            livesDisplay.textContent = data.lives;
            drawLaser(data.yourSlope, '#ef4444');
        });

        socket.on('gameOver', () => {
            updateMessage('GAME OVER! You are out of lives!', 'miss');
            shootButton.disabled = true;
            isGameActive = false;
        });
        
        // --- Game Initialization ---
        function init() {
            shootButton.addEventListener('click', handleShoot);
            riseInput.addEventListener('input', updateCannonAngle);
            runInput.addEventListener('input', updateCannonAngle);
            
            // Modal events (unchanged)
            helpButton.addEventListener('click', showModal);
            modalOverlay.addEventListener('click', hideModal);
            modalOkButton.addEventListener('click', handleModalOk);

            if (!getCookie('hasVisited')) {
                showModal();
            }

            resizeBackground(); // Start background
            animateBackground();
            gameLoop(); // Start render loop
        }

        // Background Animation (unchanged from your code)
        const bgCanvas = document.getElementById('background-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        let backgroundDots = [];
        function resizeBackground() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
            backgroundDots = [];
            for (let i = 0; i < 200; i++) {
                backgroundDots.push({
                    x: Math.random() * bgCanvas.width,
                    y: Math.random() * bgCanvas.height,
                    speed: Math.random() * 0.5 + 0.1
                });
            }
        }
        function animateBackground() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            bgCtx.fillStyle = '#374151';
            for (let dot of backgroundDots) {
                dot.y += dot.speed;
                if (dot.y > bgCanvas.height) { dot.y = 0; dot.x = Math.random() * bgCanvas.width; }
                bgCtx.beginPath(); bgCtx.arc(dot.x, dot.y, 1, 0, Math.PI * 2); bgCtx.fill();
            }
            requestAnimationFrame(animateBackground);
        }

        init();
    });
    </script>
</body>
</html>