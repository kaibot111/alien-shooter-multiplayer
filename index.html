<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alien Slope Shooter</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘½</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <style>
        /* ... (all your old <style> content is the same) ... */
    </style>
</head>
<body class="text-gray-100 flex items-center justify-center min-h-screen p-4">

    <canvas id="background-canvas"></canvas>

    <div id="how-to-play-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        </div>

    <div id="lobby-screen" class="w-full max-w-md mx-auto bg-gray-900 bg-opacity-80 backdrop-blur-sm p-8 rounded-lg shadow-2xl border border-gray-700 text-center">
        <h1 class="text-3xl font-bold text-green-400 mb-2">Alien Slope Shooter</h1>
        <p class="text-lg text-gray-300 mb-6">Welcome, <span id="player-name" class="font-bold text-white">...</span>!</p>
        
        <button id="create-room-btn" class="btn btn-green w-full mb-4">Create Private Room</button>
        
        <div class="relative flex py-5 items-center">
            <div class="flex-grow border-t border-gray-700"></div>
            <span class="flex-shrink mx-4 text-gray-400">OR</span>
            <div class="flex-grow border-t border-gray-700"></div>
        </div>

        <div class="flex gap-4">
            <input type="text" id="room-code-input" placeholder="Enter Room Code" class="coord-input !w-full !text-lg !text-center" maxlength="4">
            <button id="join-room-btn" class="btn btn-yellow !w-32">Join</button>
        </div>
        
        <a href="/auth/logout" class="text-sm text-gray-500 hover:text-red-400 mt-8 inline-block">Logout</a>
    </div>

    <div id="game-screen" class="w-full max-w-4xl mx-auto bg-gray-900 bg-opacity-80 backdrop-blur-sm p-6 rounded-lg shadow-2xl border border-gray-700 hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-green-400" style="text-shadow: 0 0 10px #00ff00;">
                Alien Slope Shooter
            </h1>
            <div class="text-right">
                <p class="text-gray-300">ROOM CODE: <span id="room-code-display" class="font-bold text-white text-lg">----</span></p>
                <a href="/auth/logout" class="text-sm text-gray-500 hover:text-red-400">Logout</a>
            </div>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-6">
            <div class="flex-grow flex justify-center items-center">
                <canvas id="game-canvas" width="420" height="420" class="game-canvas"></canvas>
            </div>
            <div class="flex-shrink-0 lg:w-1/3 bg-gray-800 p-6 rounded-lg border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-green-300">Targeting Computer</h2>
                    <button id="help-button" class="text-sm text-blue-400 hover:text-blue-300 underline font-sans">How to Play</button>
                </div>
                <div id="message-box" class="h-16 text-center text-lg font-semibold mb-4 ...">
                    <span id="message-text" class="message-info">Connecting...</span>
                </div>
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-center text-green-300 mb-2">SCOREBOARD</h3>
                    <div id="scoreboard" class="space-y-2 max-h-32 overflow-y-auto ..."></div>
                </div>
                <div class="text-center mb-4">
                    <h3 class="text-2xl font-bold text-red-400 ...">
                        YOUR LIVES: <span id="lives-display">3</span>
                    </h3>
                </div>
                <div class="text-center mb-6">
                    <label class="text-2xl font-bold text-gray-300">EQUATION:</label>
                    <div class="flex justify-center items-center mt-3 space-x-2 text-3xl font-bold">
                        <span class="text-gray-400">y =</span>
                        <div class="flex flex-col items-center">
                            <input type="number" id="rise-input" class="coord-input !w-16 !text-lg" placeholder="y">
                            <div class="w-16 h-1 bg-gray-400 my-1 rounded"></div>
                            <input type="number" id="run-input" class="coord-input !w-16 !text-lg" placeholder="x">
                        </div>
                        <span class="text-gray-400">x +</span>
                        <span class="text-blue-400 text-4xl" style="text-shadow: 0 0 8px #3b82f6;">b</span>
                    </div>
                </div>
                <div class="flex flex-col gap-4">
                    <button id="shoot-button" class="btn btn-green" disabled>Fire Laser</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    window.addEventListener('load', () => {
        // --- Global State ---
        let myName = "";
        let myId = "";
        const socket = io();

        // --- DOM Elements ---
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const playerNameEl = document.getElementById('player-name');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const roomCodeDisplay = document.getElementById('room-code-display');

        // (Game DOM Elements)
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const shootButton = document.getElementById('shoot-button');
        const riseInput = document.getElementById('rise-input');
        const runInput = document.getElementById('run-input');
        const messageText = document.getElementById('message-text');
        const messageBox = document.getElementById('message-box');
        const livesDisplay = document.getElementById('lives-display');
        const scoreboard = document.getElementById('scoreboard');
        const helpButton = document.getElementById('help-button');
        const modal = document.getElementById('how-to-play-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalOkButton = document.getElementById('modal-ok-button');

        // (Canvas & Game State)
        let cannonYIntercept = 0, currentAliens = [];
        let cannonAngle = 0, targetAngle = 0, isGameActive = true;
        const canvasWidth = canvas.width, canvasHeight = canvas.height;
        const gridSize = 20, gridMax = 10;
        const centerX = canvasWidth / 2, centerY = canvasHeight / 2;
        
        // (Cannon Image)
        const cannonImage = new Image();
        let isCannonImageLoaded = false;
        cannonImage.src = 'data:image/svg+xml,...'; // (Same as before)
        cannonImage.onload = () => { isCannonImageLoaded = true; updateCannonAngle(); };

        // --- All Drawing & Helper Functions (Unchanged) ---
        // All functions like gridToCanvas, drawAxes, drawGridLines,
        // drawGame, drawAliens, drawCannon, drawLaser, drawExplosion,
        // updateMessage, getPlayerSlope, updateCannonAngle, gameLoop,
        // getCookie, showModal, hideModal...
        // ...are EXACTLY THE SAME as the previous multiplayer version.
        // (Copy/paste all of them here from the previous answer)
        
        // [ --- All drawing functions from previous answer go here --- ]
        
        // --- NEW Lobby Logic ---
        createRoomBtn.addEventListener('click', () => {
            socket.emit('createRoom', { name: myName });
        });
        
        joinRoomBtn.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.trim();
            if (roomCode.length === 4) {
                socket.emit('joinRoom', { roomCode: roomCode, name: myName });
            } else {
                alert("Please enter a 4-digit room code.");
            }
        });

        // --- NEW Socket Event Listeners ---
        socket.on('roomJoined', (roomCode) => {
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            roomCodeDisplay.textContent = roomCode;
        });
        
        socket.on('error', (message) => {
            alert(message);
        });
        
        // (All other game listeners are the same as before)
        // socket.on('connect', ...)
        // socket.on('newRound', ...)
        // socket.on('updatePlayers', ...)
        // socket.on('hit', ...)
        // socket.on('myMiss', ...)
        // socket.on('gameOver', ...)

        // --- Main Initialization ---
        async function init() {
            // 1. Find out who I am
            try {
                const response = await fetch('/api/me');
                const user = await response.json();
                myName = user.name;
                myId = user.id;
                playerNameEl.textContent = myName;
            } catch (err) {
                console.error("Could not fetch user info", err);
                playerNameEl.textContent = "Error";
            }
            
            // 2. Setup Game Listeners
            shootButton.addEventListener('click', handleShoot);
            riseInput.addEventListener('input', updateCannonAngle);
            runInput.addEventListener('input', updateCannonAngle);
            helpButton.addEventListener('click', showModal);
            modalOverlay.addEventListener('click', hideModal);
            modalOkButton.addEventListener('click', handleModalOk);
            
            // 3. Start Background
            resizeBackground();
            animateBackground();
            gameLoop();
        }

        // (Remember to copy/paste all drawing, helper, and background
        // functions from the previous answer into this script)
        
        init();
    });
    // ... (rest of all your functions from the previous answer's script) ...
    </script>
</body>
</html>
